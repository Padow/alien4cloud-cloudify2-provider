
name: tomcat
namespace: fastconnect
description: Tomcat recipe for tests. Updated with custom commands on Tomcat node

node_types:

  fastconnect.nodes.War:
    derived_from: tosca.nodes.WebApplication
    description: >
      A war element
    properties:
      contextPath:
        type: string
        required: true
    requirements:
      host:
        type: alien4cloud.capabilities.WarHosting
        lower_bound: 1
        upper_bound: 1
    interfaces:
      custom:
        operations:
          updateWarFile:
            input_parameters:
              warUrl:
                type: string
            implementation_artifact:
              artifact_type: tosca.artifacts.GroovyScript
              artifact_ref: "warScripts/updateWarFile.groovy"
    artifacts:
      scripts:
        artifact_type: fastconnect.artifacts.ResourceDirectory
        artifact_ref: warScripts
      war_file:
        artifact_type: fastconnect.artifacts.WarFile
        artifact_ref: "warFiles/helloWorld.war"

  fastconnect.nodes.Tomcat:
    derived_from: tosca.nodes.WebServer
    description: >
      Installation of Tomcat using Cloudify scripts
    tags:
      icon: /images/tomcat.gif
    properties:
      version:
        type: version
        default: 7.0.23
        constraints:
          - equal: 7.0.23
    capabilities:
      http_endpoint:
        type: alien4cloud.capabilities.HttpEndpoint
        lower_bound: 0
        upper_bound: unbounded
      war_host:
        type: alien4cloud.capabilities.WarHosting
        lower_bound: 0
        upper_bound: unbounded
    requirements:
      http_endpoint:
        type: alien4cloud.capabilities.HttpEndpoint
        lower_bound: 0
        upper_bound: unbounded
      jdbc_resource:
        type: alien4cloud.capabilities.JdbcEndpoint
        lower_bound: 0
        upper_bound: 1
    interfaces:
      lifecycle:
        operations:
          create:
            implementation_artifact:
              artifact_type: tosca.artifacts.GroovyScript
              artifact_ref: "scripts/tomcat_installAlien.groovy"
          start:
            implementation_artifact:
              artifact_type: tosca.artifacts.GroovyScript
              artifact_ref: "scripts/tomcat_start.groovy"
          stop:
            implementation_artifact:
              artifact_type: tosca.artifacts.GroovyScript
              artifact_ref: "scripts/tomcat_stop.groovy"
      fastconnect.cloudify.extensions:
        operations:
          start_detection:
            implementation_artifact:
              artifact_type: tosca.artifacts.GroovyScript
              artifact_ref: scripts/tomcat_startDetection.groovy
          stop_detection:
            implementation_artifact:
              artifact_type: tosca.artifacts.GroovyScript
              artifact_ref: scripts/tomcat_stopDetection.groovy
          locator:
            implementation_artifact:
              artifact_type: tosca.artifacts.GroovyScript
              artifact_ref: scripts/alien_tomcat_locator.groovy
      custom:
        operations:
          updateNodeWar:
            input_parameters:
              warNodeName:
                type: string
            implementation_artifact:
              artifact_type: tosca.artifacts.GroovyScript
              artifact_ref: "scripts/updateNodeWarFile.groovy"
    artifacts:
      scripts:
        artifact_type: fastconnect.artifacts.ResourceDirectory
        artifact_ref: "scripts"

  fastconnect.nodes.TomcatSh:
    derived_from: fastconnect.nodes.Tomcat
    description: >
      Installation of Tomcat from a ZIP archive downloaded from the Web using sh scripts.
    interfaces:
      lifecycle:
        operations:
          create: scripts/tomcatSh/tomcat_install.sh
          start:  scripts/tomcatSh/tomcat_start.sh
          stop:   scripts/tomcatSh/tomcat_stop.sh


relationship_types:
  fastconnect.relationships.cloudify.ConnectsTomcatToPostgre:
    derived_from: tosca.relationships.ConnectsTo
    description: >
      Connects Tomcat to an PostgreSQL
    valid_sources: [ alien4cloud.capabilities.JdbcEndpoint ]
    valid_targets: [ alien4cloud.capabilities.JdbcEndpoint ]
    interfaces:
      tosca.interfaces.relationship.Configure:
        operations:
          pre_configure_source:
            implementation_artifact:
              artifact_type: tosca.artifacts.GroovyScript
              artifact_ref: "relationshipScripts/tomcat_configureDatasource.groovy"
          post_configure_source:
            implementation_artifact:
              artifact_type: tosca.artifacts.GroovyScript
              artifact_ref: "relationshipScripts/tomcat_postgreAddUser.groovy"
    artifacts:
      scripts:
        artifact_type: fastconnect.artifacts.ResourceDirectory
        artifact_ref: relationshipScripts

  fastconnect.relationships.cloudify.ConnectsToApacheLB:
    derived_from: tosca.relationships.ConnectsTo
    description: >
      Connects Tomcat to an ApacheLB
    valid_sources: [ alien4cloud.capabilities.HttpEndpoint ]
    valid_targets: [ alien4cloud.capabilities.HttpEndpoint ]
    interfaces:
      tosca.interfaces.relationship.Configure:
        operations:
          add_target:
            implementation_artifact:
              artifact_type: tosca.artifacts.GroovyScript
              artifact_ref: "relationshipScripts/tomcat_connectto_apache_addtarget.groovy"
          remove_target:
            implementation_artifact:
              artifact_type: tosca.artifacts.GroovyScript
              artifact_ref: "relationshipScripts/tomcat_connectto_apache_removetarget.groovy"
    artifacts:
      scripts:
        artifact_type: fastconnect.artifacts.ResourceDirectory
        artifact_ref: relationshipScripts

  fastconnect.relationships.cloudify.WarHostedOnTomcat:
    derived_from: tosca.relationships.HostedOn
    description: Relationship that allows to deploy a war on tomcat.
    valid_sources: [ alien4cloud.capabilities.WarHosting ]
    valid_targets: [ alien4cloud.capabilities.WarHosting ]
    interfaces:
      tosca.interfaces.relationship.Configure:
        operations:
          post_configure_source:
            implementation_artifact:
              artifact_type: tosca.artifacts.GroovyScript
              artifact_ref: "relationshipScripts/war_hostedon_tomcat_postsource.groovy"
    artifacts:
      scripts:
        artifact_type: fastconnect.artifacts.ResourceDirectory
        artifact_ref: relationshipScripts

capability_types:
  alien4cloud.capabilities.WarHosting:
    derived_from: tosca.capabilities.Container
  alien4cloud.capabilities.TomcatJdbcEndpoint:
    derived_from: tosca.capabilities.Endpoint
  alien4cloud.capabilities.JdbcEndpoint:
    derived_from: tosca.capabilities.Endpoint
