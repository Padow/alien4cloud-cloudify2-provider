tosca_definitions_version: tosca_simple_yaml_1_0_0_wd03

description: Tomcat recipe for tests. Updated with custom commands on Tomcat node.

node_types:
  fastconnect.nodes.War:
    derived_from: tosca.nodes.WebApplication
    description: A war element
    properties:
      contextPath:
        type: string
        required: true
    requirements:
      - host: alien4cloud.capabilities.WarHosting
        lower_bound: 1
        upper_bound: 1
        
    interfaces:
      custom:
        updateWarFile:
          inputs:
            warUrl:
              type: string
              description: url of the war to upload to update the current one
          implementation: warScripts/updateWarFile.groovy
          
    artifacts:
      - scripts: warScripts
        type: tosca.artifacts.File
      - war_file: warFiles/helloWorld.war
        type: fastconnect.artifacts.WarFile
        
  fastconnect.nodes.Tomcat:
    derived_from: tosca.nodes.WebServer
    description: >
      Installation of Tomcat using Cloudify scripts
    tags:
      icon: /images/tomcat.gif
    properties:
      version:
        type: version
        default: 7.0.23
        constraints:
          - equal: 7.0.23
    capabilities:
      http_endpoint:
        type: alien4cloud.capabilities.HttpEndpoint
        upper_bound: unbounded
      war_host:
          type: alien4cloud.capabilities.WarHosting
          upper_bound: unbounded
    requirements:
      - http_endpoint: alien4cloud.capabilities.HttpEndpoint
        lower_bound: 0
        upper_bound: unbounded
      - jdbc_resource: alien4cloud.capabilities.JdbcEndpoint
        lower_bound: 0
        upper_bound: 1
    interfaces:
      Standard:
        create: scripts/tomcat_installAlien.groovy
        start: scripts/tomcat_start.groovy
        stop: scripts/tomcat_stop.groovy
      fastconnect.cloudify.extensions:
        start_detection: scripts/tomcat_startDetection.groovy
        stop_detection: scripts/tomcat_stopDetection.groovy
        locator: scripts/alien_tomcat_locator.groovy
      custom:
        updateNodeWar:
          input:
            warNodeName:
              type: string
              required: true
          implementation: scripts/updateNodeWarFile.groovy
        helloCmd:
          input:
            yourName:
              type: string
              required: true
          implementation: scripts/helloCmd.groovy
    artifacts:
      - scripts: scripts
        type: tosca.artifacts.File

  fastconnect.nodes.TomcatSh:
    derived_from: fastconnect.nodes.Tomcat
    description: >
      Installation of Tomcat from a ZIP archive downloaded from the Web using sh scripts.
    interfaces:
      Standard:
        create: scripts/tomcatSh/tomcat_install.sh
        start: scripts/tomcatSh/tomcat_start.sh
        stop: scripts/tomcatSh/tomcat_stop.sh


relationship_types:
  fastconnect.relationships.cloudify.ConnectsTomcatToPostgre:
    derived_from: tosca.relationships.ConnectsTo
    description: >
      Connects Tomcat to an PostgreSQL
    valid_sources: [ alien4cloud.capabilities.JdbcEndpoint ]
    valid_targets: [ alien4cloud.capabilities.JdbcEndpoint ]
    interfaces:
      configure:
        pre_configure_source: relationshipScripts/tomcat_configureDatasource.groovy
        post_configure_source: relationshipScripts/tomcat_postgreAddUser.groovy
    artifacts:
      - scripts: relationshipScripts
        type: tosca.artifacts.File

  fastconnect.relationships.cloudify.ConnectsToApacheLB:
    derived_from: tosca.relationships.ConnectsTo
    description: >
      Connects Tomcat to an ApacheLB
    valid_sources: [ alien4cloud.capabilities.HttpEndpoint ]
    valid_targets: [ alien4cloud.capabilities.HttpEndpoint ]
    interfaces:
      configure:
        add_target: relationshipScripts/tomcat_connectto_apache_addtarget.groovy
        remove_target: relationshipScripts/tomcat_connectto_apache_removetarget.groovy
    artifacts:
      - scripts: relationshipScripts
        type: tosca.artifacts.File

  fastconnect.relationships.cloudify.WarHostedOnTomcat:
    derived_from: tosca.relationships.HostedOn
    description: Relationship that allows to deploy a war on tomcat.
    valid_sources: [ alien4cloud.capabilities.WarHosting ]
    valid_targets: [ alien4cloud.capabilities.WarHosting ]
    interfaces:
      configure:
        post_configure_source: relationshipScripts/war_hostedon_tomcat_postsource.groovy
    artifacts:
      - scripts: relationshipScripts
        type: tosca.artifacts.File

capability_types:
  alien4cloud.capabilities.WarHosting:
    derived_from: tosca.capabilities.Container
  alien4cloud.capabilities.TomcatJdbcEndpoint:
    derived_from: tosca.capabilities.Endpoint
  alien4cloud.capabilities.JdbcEndpoint:
    derived_from: tosca.capabilities.Endpoint
